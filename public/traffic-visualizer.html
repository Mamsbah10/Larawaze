<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Visualiseur de Trafic - LaraWaze</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
                    Roboto, sans-serif;
                background: #f5f5f5;
            }

            .container {
                display: grid;
                grid-template-columns: 1fr 300px;
                height: 100vh;
                gap: 10px;
                padding: 10px;
            }

            #map {
                border-radius: 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 1;
            }

            .sidebar {
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                overflow-y: auto;
            }

            .sidebar h2 {
                color: #667eea;
                margin-bottom: 15px;
                font-size: 1.3em;
            }

            .location-list {
                list-style: none;
            }

            .location-item {
                padding: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 5px;
                margin-bottom: 10px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .location-item:hover {
                background: #f0f0f0;
                border-color: #667eea;
            }

            .location-item.active {
                background: #667eea;
                color: white;
                border-color: #667eea;
            }

            .location-item strong {
                display: block;
                margin-bottom: 5px;
            }

            .location-item small {
                opacity: 0.8;
            }

            .legend {
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px solid #e0e0e0;
            }

            .legend h3 {
                font-size: 0.9em;
                color: #333;
                margin-bottom: 10px;
            }

            .legend-item {
                display: flex;
                align-items: center;
                margin-bottom: 8px;
                font-size: 0.85em;
            }

            .legend-color {
                width: 20px;
                height: 5px;
                border-radius: 3px;
                margin-right: 10px;
            }

            .legend-item.green .legend-color {
                background: #4caf50;
            }

            .legend-item.orange .legend-color {
                background: #ff9800;
            }

            .legend-item.red .legend-color {
                background: #f44336;
            }

            .controls {
                margin-top: 20px;
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            button {
                padding: 10px;
                border: none;
                border-radius: 5px;
                background: #667eea;
                color: white;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s;
                font-size: 0.9em;
            }

            button:hover {
                background: #764ba2;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            }

            button.secondary {
                background: #999;
            }

            button.secondary:hover {
                background: #777;
            }

            .info-box {
                background: #e3f2fd;
                border-left: 4px solid #2196f3;
                padding: 10px;
                border-radius: 3px;
                margin-top: 15px;
                font-size: 0.85em;
                color: #333;
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: #999;
            }

            .spinner {
                border: 2px solid #f3f3f3;
                border-top: 2px solid #667eea;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                animation: spin 1s linear infinite;
                margin: 10px auto;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            @media (max-width: 768px) {
                .container {
                    grid-template-columns: 1fr;
                }

                .sidebar {
                    position: absolute;
                    bottom: 0;
                    right: 0;
                    width: 100%;
                    border-radius: 8px 8px 0 0;
                    max-height: 300px;
                    z-index: 10;
                }

                #map {
                    height: 70vh;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div id="map"></div>

            <div class="sidebar">
                <h2>üöó Trafic</h2>

                <ul class="location-list" id="locationList">
                    <li
                        class="location-item active"
                        data-lat="48.8566"
                        data-lon="2.3522"
                    >
                        <strong>Paris Centre</strong>
                        <small>48.8566¬∞N, 2.3522¬∞E</small>
                    </li>
                    <li
                        class="location-item"
                        data-lat="48.8626"
                        data-lon="2.3950"
                    >
                        <strong>Gare de l'Est</strong>
                        <small>48.8626¬∞N, 2.3950¬∞E</small>
                    </li>
                    <li
                        class="location-item"
                        data-lat="48.8424"
                        data-lon="2.3536"
                    >
                        <strong>Notre-Dame</strong>
                        <small>48.8424¬∞N, 2.3536¬∞E</small>
                    </li>
                    <li
                        class="location-item"
                        data-lat="48.8704"
                        data-lon="2.2905"
                    >
                        <strong>Bois de Boulogne</strong>
                        <small>48.8704¬∞N, 2.2905¬∞E</small>
                    </li>
                    <li
                        class="location-item"
                        data-lat="48.8950"
                        data-lon="2.3708"
                    >
                        <strong>Parc Buttes-aux-Cailles</strong>
                        <small>48.8950¬∞N, 2.3708¬∞E</small>
                    </li>
                </ul>

                <div class="legend">
                    <h3>L√©gende</h3>
                    <div class="legend-item green">
                        <div class="legend-color"></div>
                        Fluide (>80%)
                    </div>
                    <div class="legend-item orange">
                        <div class="legend-color"></div>
                        Ralenti (50-80%)
                    </div>
                    <div class="legend-item red">
                        <div class="legend-color"></div>
                        Embouteillage (<50%)
                    </div>
                </div>

                <div class="controls">
                    <button onclick="loadTraffic()">üîÑ Charger</button>
                    <button class="secondary" onclick="clearTraffic()">
                        üóëÔ∏è Effacer
                    </button>
                </div>

                <div class="info-box">
                    Info: Cliquez sur un endroit pour charger le trafic. Les
                    segments sont colores selon la congestion.
                </div>
            </div>
        </div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="/js/TrafficFlowVisualizer.js"></script>

        <script>
            // Gardes globales
            let mapInitialized = false;
            let mapInstance = null;
            let trafficVizInstance = null;

            // Fonction pour initialiser la map et les event listeners
            function initializeMap() {
                if (mapInitialized) {
                    console.warn("Map already initialized, skipping...");
                    return;
                }

                if (mapInstance !== null) {
                    console.warn(
                        "mapInstance already exists, skipping initialization..."
                    );
                    return;
                }

                console.log("Initializing map and traffic visualizer...");
                mapInitialized = true;

                try {
                    // Initialiser la carte
                    mapInstance = L.map("map").setView([48.8566, 2.3522], 12);

                    L.tileLayer(
                        "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                        {
                            attribution: "OpenStreetMap contributors",
                            maxZoom: 19,
                        }
                    ).addTo(mapInstance);

                    // Creer le visualiseur de trafic AVANT d'ajouter les event listeners
                    trafficVizInstance = new TrafficFlowVisualizer(mapInstance);
                    console.log(
                        "TrafficVizInstance created:",
                        trafficVizInstance
                    );

                    // Ajouter les event listeners aux items de la liste
                    document
                        .querySelectorAll(".location-item")
                        .forEach((item) => {
                            item.addEventListener("click", function () {
                                // Mettre a jour la selection
                                document
                                    .querySelectorAll(".location-item")
                                    .forEach((i) =>
                                        i.classList.remove("active")
                                    );
                                this.classList.add("active");

                                // Recuperer les coordonnees
                                const lat = parseFloat(this.dataset.lat);
                                const lon = parseFloat(this.dataset.lon);
                                const name =
                                    this.querySelector("strong").textContent;

                                // Centrer la carte
                                mapInstance.setView([lat, lon], 15);

                                // Charger le trafic - v√©rifier que trafficVizInstance existe
                                if (trafficVizInstance) {
                                    loadTraffic(lat, lon, name);
                                } else {
                                    console.error("TrafficViz not initialized");
                                }
                            });
                        });

                    // Rendre les fonctions globales
                    window.loadTraffic = loadTraffic;
                    window.clearTraffic = clearTraffic;

                    console.log(
                        "Map initialization complete, loading initial traffic..."
                    );

                    // Charger le trafic au demarrage (APRES que tout soit initialise)
                    loadTraffic(48.8566, 2.3522, "Paris Centre");
                } catch (error) {
                    console.error("Error initializing map:", error);
                    mapInitialized = false;
                    mapInstance = null;
                }
            }

            // Charger le trafic pour une localite
            async function loadTraffic(lat = null, lon = null, name = null) {
                if (!trafficVizInstance) {
                    console.error("TrafficViz not initialized yet");
                    return;
                }

                if (lat === null) {
                    const active = document.querySelector(
                        ".location-item.active"
                    );
                    if (!active) return;
                    lat = parseFloat(active.dataset.lat);
                    lon = parseFloat(active.dataset.lon);
                    name = active.querySelector("strong").textContent;
                }

                const sidebar = document.querySelector(".sidebar");

                // Effacer les anciens segments de la carte
                clearTraffic();

                // Effacer les infos precedentes
                document.querySelectorAll(".info-box").forEach((box) => {
                    const controls = sidebar.querySelector(".controls");
                    if (box !== controls.nextElementSibling) {
                        box.remove();
                    }
                });

                // Afficher le loader
                const loadingDiv = document.createElement("div");
                loadingDiv.className = "loading";
                loadingDiv.innerHTML =
                    '<div class="spinner"></div><p>Chargement du trafic...</p>';
                sidebar.appendChild(loadingDiv);

                try {
                    const response = await fetch(
                        `/api/traffic/flow?latitude=${lat}&longitude=${lon}`
                    );
                    const data = await response.json();

                    // Effacer le loader
                    if (loadingDiv.parentNode) {
                        sidebar.removeChild(loadingDiv);
                    }

                    if (data.flowSegmentData) {
                        // Afficher les donnees
                        const flowData = data.flowSegmentData;
                        const speedPercent = Math.round(
                            (flowData.currentSpeed / flowData.freeFlowSpeed) *
                                100
                        );

                        const infoDiv = document.createElement("div");
                        infoDiv.className = "info-box";
                        infoDiv.style.background = "#f5f5f5";
                        infoDiv.style.borderLeft = "none";
                        infoDiv.style.marginTop = "15px";
                        infoDiv.innerHTML = `
                        <strong style="color: #333; display: block; margin-bottom: 10px;">Localite: ${name}</strong>
                        <div style="font-size: 0.9em; color: #666;">
                            <div style="margin-bottom: 8px;">
                                <strong style="color: #667eea;">Vitesse: ${
                                    flowData.currentSpeed
                                } km/h</strong>
                                <small style="display: block; color: #999;">Normal: ${
                                    flowData.freeFlowSpeed
                                } km/h</small>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Congestion: ${
                                    100 - speedPercent
                                }%</strong>
                            </div>
                            <div>
                                <small>Temps: ${Math.round(
                                    flowData.currentTravelTime / 60
                                )}min (normal: ${Math.round(
                            flowData.freeFlowTravelTime / 60
                        )}min)</small>
                            </div>
                        </div>
                    `;
                        sidebar.appendChild(infoDiv);

                        // Ajouter le segment a la carte
                        trafficVizInstance.addTrafficSegment(flowData);
                    } else {
                        const errorDiv = document.createElement("div");
                        errorDiv.className = "info-box";
                        errorDiv.style.background = "#ffebee";
                        errorDiv.style.borderLeftColor = "#f44336";
                        errorDiv.innerHTML =
                            "<strong>Erreur:</strong> Pas de donnees disponibles";
                        sidebar.appendChild(errorDiv);
                    }
                } catch (error) {
                    if (loadingDiv.parentNode) {
                        sidebar.removeChild(loadingDiv);
                    }
                    const errorDiv = document.createElement("div");
                    errorDiv.className = "info-box";
                    errorDiv.style.background = "#ffebee";
                    errorDiv.style.borderLeftColor = "#f44336";
                    errorDiv.innerHTML = `<strong>Erreur:</strong> ${error.message}`;
                    sidebar.appendChild(errorDiv);
                    console.error("Error:", error);
                }
            }

            // Effacer le trafic
            function clearTraffic() {
                if (!mapInstance) return;

                // Effacer la couche de trafic
                mapInstance.eachLayer((layer) => {
                    if (
                        layer instanceof L.Polyline &&
                        !(layer instanceof L.Popup)
                    ) {
                        mapInstance.removeLayer(layer);
                    }
                });

                // Effacer les infos dans le sidebar
                const sidebar = document.querySelector(".sidebar");
                const controls = sidebar.querySelector(".controls");
                document.querySelectorAll(".info-box").forEach((box) => {
                    if (box !== controls.nextElementSibling) {
                        box.remove();
                    }
                });
            }

            // Initialiser une seule fois lors du chargement
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", initializeMap, {
                    once: true,
                });
            } else {
                // DOM est deja charge - initialiser immediatement
                initializeMap();
            }
        </script>
    </body>
</html>
