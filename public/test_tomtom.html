<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Test TomTom Traffic API</title>
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet/dist/leaflet.css"
        />
        <style>
            body {
                margin: 0;
                padding: 20px;
                font-family: Arial, sans-serif;
            }
            #map {
                height: 600px;
                border: 2px solid #ccc;
                margin: 20px 0;
            }
            .controls {
                margin: 20px 0;
            }
            button {
                padding: 10px 20px;
                margin: 5px;
                cursor: pointer;
                font-size: 16px;
            }
            .log {
                border: 1px solid #ddd;
                padding: 15px;
                height: 300px;
                overflow-y: auto;
                background: #f5f5f5;
            }
            .log p {
                margin: 5px 0;
                font-family: monospace;
                font-size: 12px;
            }
            .error {
                color: red;
            }
            .success {
                color: green;
            }
            .info {
                color: blue;
            }
        </style>
    </head>
    <body>
        <h1>üö¶ Test API TomTom Traffic</h1>

        <div class="controls">
            <button onclick="testAPI()">üß™ Tester API Directement</button>
            <button onclick="toggleTraffic()">
                üõ£Ô∏è Activer/D√©sactiver Trafic
            </button>
            <button onclick="clearLogs()">üóëÔ∏è Effacer Logs</button>
        </div>

        <div id="map"></div>

        <h3>üìã Console de D√©bogage:</h3>
        <div class="log" id="logs"></div>

        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <script>
            const API_KEY = "uYMyamzlK0GNtueiA9CfOJMIbAI22lRS";
            let map,
                trafficLayer,
                trafficEnabled = false;

            function log(message, type = "info") {
                const logsDiv = document.getElementById("logs");
                const timestamp = new Date().toLocaleTimeString();
                const className = type; // "info", "error", "success"
                logsDiv.innerHTML += `<p class="${className}">[${timestamp}] ${message}</p>`;
                logsDiv.scrollTop = logsDiv.scrollHeight;
                console.log(message);
            }

            function clearLogs() {
                document.getElementById("logs").innerHTML = "";
            }

            function testAPI() {
                log("üß™ Test de l'API TomTom...", "info");

                const tileUrl = `https://api.tomtom.com/traffic/map/4/flow/absolute/13/4352/2891.png?key=${API_KEY}`;
                log(
                    `üì° URL test√©e: ${tileUrl.replace(API_KEY, "KEY***")}`,
                    "info"
                );

                fetch(tileUrl, { method: "HEAD", mode: "no-cors" })
                    .then((response) => {
                        log(
                            `‚úÖ R√©ponse API: ${response.status} ${response.statusText}`,
                            "success"
                        );
                    })
                    .catch((error) => {
                        log(`‚ùå Erreur API: ${error}`, "error");
                    });
            }

            function toggleTraffic() {
                log("üìç Toggle du trafic...", "info");

                if (!trafficLayer) {
                    log("‚ùå Couche trafic non initialis√©e!", "error");
                    return;
                }

                if (!trafficEnabled) {
                    log("‚úÖ Activation du trafic...", "info");
                    try {
                        trafficLayer.addTo(map);
                        trafficEnabled = true;
                        log("‚úÖ Trafic activ√© sur la carte!", "success");
                    } catch (err) {
                        log(`‚ùå Erreur: ${err.message}`, "error");
                    }
                } else {
                    log("‚ùå D√©sactivation du trafic...", "info");
                    try {
                        map.removeLayer(trafficLayer);
                        trafficEnabled = false;
                        log("‚ùå Trafic d√©sactiv√© de la carte!", "success");
                    } catch (err) {
                        log(`‚ùå Erreur: ${err.message}`, "error");
                    }
                }
            }

            // Initialisation
            document.addEventListener("DOMContentLoaded", () => {
                log("üöÄ Initialisation...", "info");

                // Cr√©er la carte
                map = L.map("map").setView([48.8566, 2.3522], 12); // Paris par d√©faut
                log("‚úÖ Carte Leaflet cr√©√©e", "success");

                // Ajouter le fond OSM
                L.tileLayer(
                    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                    {
                        attribution: "¬© OpenStreetMap",
                    }
                ).addTo(map);
                log("‚úÖ Tuiles OSM charg√©es", "success");

                // Cr√©er la couche trafic
                const trafficUrl = `https://api.tomtom.com/traffic/map/4/flow/absolute/{z}/{x}/{y}.png?key=${API_KEY}`;
                log(
                    `üì° Cr√©ation de la couche avec: ${trafficUrl.replace(
                        API_KEY,
                        "KEY***"
                    )}`,
                    "info"
                );

                try {
                    trafficLayer = L.tileLayer(trafficUrl, {
                        attribution: "¬© TomTom",
                        maxZoom: 22,
                        opacity: 0.8,
                        crossOrigin: "anonymous",
                    });
                    log("‚úÖ Couche TomTom Traffic cr√©√©e!", "success");
                    log(
                        "üí° Cliquez sur 'üõ£Ô∏è Activer/D√©sactiver Trafic' pour afficher le trafic",
                        "info"
                    );
                } catch (err) {
                    log(`‚ùå Erreur cr√©ation couche: ${err.message}`, "error");
                }
            });
        </script>
    </body>
</html>
